---
title: 'Documento de código: Preferencias redistributivas en contextos desiguales'
author: "Gonzalo Franetovic"
date: "22/10/2018"
output:
  html_document: default
  pdf_document: default
  word_document: default
---
 A continuación se presenta el documento de código de la presente investigación. Se expone paso a paso el ajuste y fundición de bases de datos, limpieza y recodificación de variables, estimación de modelo y visualizaciones gráficas. Cabe precisar que se extrajeron las bases de datos directamente desde la página web de Lapop, por lo que hay diferencias mínimas en algunas variables. 
 
+ Instalación Paquetes de trabajo

```{r Paquetes, echo=TRUE, message=FALSE, warning=FALSE}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(car, stargazer, haven, foreign, stargazer, xtable, psych, psy, base, magrittr, readxl, lme4, texreg, varhandle, countrycode, laeken, multilevel, ggplot2, ggthemes, extrafont, plyr, data.table, doBy, multiwayvcov, miceadds, RColorBrewer, scales, haven, margins, grDevices, interplot, lmtest, lsmeans, lattice, broom, sjPlot, lmerTest, labelled, dplyr, sjmisc, tidyverse, Hmisc, devtools, DescTools, descr)
search()
```

+ Lectura de bases de datos LAPOP 2008, 2010, 2012, 2014 y transformación a dataframe.

```{r Bases Merge, echo=TRUE, message=FALSE, warning=FALSE}
#Directorio y bases de datos
lp08 <- read_dta("Bases/OriginalLapop/2008.dta")
lp10 <- read_dta("Bases/OriginalLapop/2010.dta")
lp12 <- read_dta("Bases/OriginalLapop/2012.dta")
lp14 <- read_dta("Bases/OriginalLapop/2014.dta")
#Transformación a Data Frame 
lp08=as.data.frame(lp08) 
lp10=as.data.frame(lp10)
lp12=as.data.frame(lp12)
lp14=as.data.frame(lp14)
#Nombres de las variables en minúscula
names(lp08)= tolower(names(lp08)) 
names(lp10)= tolower(names(lp10)) 
names(lp12)= tolower(names(lp12)) 
names(lp14)= tolower(names(lp14)) 
```

+ Exploración y fundición de la bases de datos 

```{r Fundir bases merge, echo=TRUE, message=FALSE, warning=FALSE}
#Revisamos los primeros casos
head (lp08)
head (lp10)
head (lp12)
head (lp14)
#Generamos variable year para la base de 2014
lp14$year <- "2014"
#Selección de variables
#2008
lp081=lp08 %>% dplyr::select(pais, year, idnum, weight1500, ros4, q1, q2, q11, l1, ocup4a, ed, q10, ur, tamano, b12, b18, b10a, b21a, b13, b21, q12)
colnames(lp081) <- c("pais","year", "id", "weight1500", "redistribucion", "sexo", "edad", "ecivil", "ideopolitica", "sitlaboral", "educacion", "ingreso", "zona", "tamanociudad", "conffaa", "confpolicia", "confjudicial", "confejecutivo", "confcongreso", "confpartidos", "hijos")
head (lp081)
#2010
lp101=lp10 %>% dplyr::select(pais, year, idnum, weight1500, ros4, q1, q2, q11, l1, ocup4a, ed, q10, ur, tamano, b12, b18, b10a, b21a, b13, b21, q12)
colnames(lp101) <- c("pais","year", "id", "weight1500" , "redistribucion", "sexo", "edad", "ecivil", "ideopolitica", "sitlaboral", "educacion", "ingreso", "zona", "tamanociudad", "conffaa", "confpolicia", "confjudicial", "confejecutivo", "confcongreso", "confpartidos", "hijos")
head (lp101)
#2012
lp121=lp12 %>% dplyr::select(pais, year, idnum, weight1500, ros4, q1, q2, q11, l1, ocup4a, ed, q10new, ur, tamano, b12, b18, b10a, b21a, b13, b21, q12)
colnames(lp121) <- c("pais","year", "id", "weight1500" , "redistribucion", "sexo", "edad", "ecivil", "ideopolitica", "sitlaboral", "educacion", "ingreso", "zona", "tamanociudad", "conffaa", "confpolicia", "confjudicial", "confejecutivo", "confcongreso", "confpartidos", "hijos")
head (lp121)
#2014
lp141=lp14 %>% dplyr::select(pais, year, uniq_id, weight1500, ros4, q1, q2, q11n, l1, ocup4a, ed, q10, q10new, ur, tamano, b12, b18, b10a, b21a, b13, b21, q12)
colnames(lp141) <- c("pais","year", "id", "weight1500", "redistribucion", "sexo", "edad", "ecivil", "ideopolitica", "sitlaboral", "educacion", "ingreso", "zona", "tamanociudad", "conffaa", "confpolicia", "confjudicial", "confejecutivo", "confcongreso", "confpartidos", "hijos")
head (lp141)
 #Fundir Bases de datos
lapop=rbind(lp081, lp101, lp121, lp141)
lapop <- lapop[order(lapop$pais), ]
```
 
 + Imputamos variable "WT" (Peso País) desde base externa para posterior ponderación de las bases de datos individuales de los países
 
```{r Base wt, echo=TRUE, message=FALSE, warning=FALSE}
#Importamos base de datos externa
wt <- read_dta("Bases/wt.dta")
wt=as.data.frame(wt) #Transformamos a data frame
colnames(wt) <- c("pais", "year", "id", "wt")
#Removemos los países y olas que no vamos a considerar en la muestra
wt<-wt[!(wt$pais>21),]
wt$pais[wt$pais==21] <- "18"
wt$pais <- factor(wt$pais,
levels = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18),
labels = c("MEX", "GTM", "SLV", "HND", "NIC", "CRI", "PAN", "COL", "ECU", "BOL", "PER", "PRY", "CHL", "URY", "BRA", "VEN", "ARG", "DOM"))
wt<-wt[!(wt$year<2008),]
wt <- wt[order(wt$pais), ]
#Merge: Se agregan observaciones con "wt", pero sin información para las variabales del estudio: Se procede a borrar esos casos
lapop <- merge(lapop, wt, by=c("pais", "year", "id"), all.x= TRUE)
#Eliminamos casos duplicados generados y variables merge
lapop <- ddply(lapop, .(lapop$pais, lapop$year, lapop$id), unique)
lapop$`lapop$pais` <-NULL
lapop$`lapop$year` <-NULL
lapop$`lapop$id` <-NULL
#Revisamos
table(lapop$pais, lapop$year)
```
 
+ Base de datos fundida por LAPOP (Se utiliza esta base para las estimaciones). Disponible [Aquí] (http://datasets.americasbarometer.org/database/index.php?freeUser=true)

```{r Base Lapop publica, echo=TRUE, message=FALSE, warning=FALSE}
#Directorio y bases de datos
lapop <- read_dta("Bases/OriginalLapop/Lapop_reducida.dta")
lapop=as.data.frame(lapop) #Transformación a Data Frame  
names(lapop)= tolower(names(lapop)) #Nombres de las variables en minúscula

#Nombre de variables 
lapop=lapop %>% dplyr::select(pais, year, idnum, weight1500, wt, ros4, q1, q2, q11, q11n, l1, ocup4a, ed, q10, q10new, ur, tamano, b12, b18, b10a, b21a, b13, b21, q12)
colnames(lapop) <- c("pais","year", "id", "weight1500", "wt", "redistribucion", "sexo", "edad", "ecivil1", "ecivil2", "ideopolitica", "sitlaboral", "educacion", "ingreso1", "ingreso2", "zona", "tamanociudad", "conffaa", "confpolicia", "confjudicial", "confejecutivo", "confcongreso", "confpartidos", "hijos")

#Ajuste de variables distintas entre años
#Estado civil
lapop$ecivil1[is.na(lapop$ecivil1)] <- 99
lapop$ecivil2[is.na(lapop$ecivil2)] <- 99
lapop$ecivil <- (lapop$ecivil1+lapop$ecivil2)-99
lapop$ecivil1 <-NULL
lapop$ecivil2 <-NULL
#Ingreso
lapop$ingreso1[is.na(lapop$ingreso1)] <- 99
lapop$ingreso2[is.na(lapop$ingreso2)] <- 99
lapop$ingreso <- (lapop$ingreso1 + lapop$ingreso2)-99
lapop$ingreso[lapop$ingreso==99] <- NA
lapop$ingreso1 <-NULL
lapop$ingreso2 <-NULL
```
 
+ Base LAPOP Full pagada por el Instituto de Ciencia Política UC (incorpora información omitida en la versión gratuita)

```{r Base Lapop full, echo=TRUE, message=FALSE, warning=FALSE}
#Directorio y bases de datos
lapop <- read_dta("Bases/OriginalLapop/Lapop_full_reducida.dta")
lapop=as.data.frame(lapop) #Transformación a Data Frame  
names(lapop)= tolower(names(lapop)) #Nombres de las variables en minúscula

#Nombre de variables 
lapop=lapop %>% dplyr::select(pais, year, idnum, weight1500, wt, ros4, q1, q2, q11, q11n, l1, ocup4a, ed, q10, q10new, ur, tamano, b12, b18, b10a, b21a, b13, b21, q12)
colnames(lapop) <- c("pais","year", "id", "weight1500", "wt", "redistribucion", "sexo", "edad", "ecivil1", "ecivil2", "ideopolitica", "sitlaboral", "educacion", "ingreso1", "ingreso2", "zona", "tamanociudad", "conffaa", "confpolicia", "confjudicial", "confejecutivo", "confcongreso", "confpartidos", "hijos")

#Ajuste de variables distintas entre años
#Estado civil
lapop$ecivil1[is.na(lapop$ecivil1)] <- 99
lapop$ecivil2[is.na(lapop$ecivil2)] <- 99
lapop$ecivil <- (lapop$ecivil1+lapop$ecivil2)-99
lapop$ecivil1 <-NULL
lapop$ecivil2 <-NULL
#Ingreso
lapop$ingreso1[is.na(lapop$ingreso1)] <- 99
lapop$ingreso2[is.na(lapop$ingreso2)] <- 99
lapop$ingreso <- (lapop$ingreso1 + lapop$ingreso2)-99
lapop$ingreso[lapop$ingreso==99] <- NA
lapop$ingreso1 <-NULL
lapop$ingreso2 <-NULL
```

+ Selección e identificación de los países y olas de la muestra
 
```{r Muestra de paises, echo=TRUE, message=FALSE, warning=FALSE}
#Removemos los países que no vamos a considerar en la muestra
lapop$pais <- as.numeric(lapop$pais)
lapop<-lapop[!(lapop$pais>21),]
lapop$pais[lapop$pais==21] <- "18"
#Países de la muestra (Etiquetas)
lapop$pais <- factor(lapop$pais,
levels = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18),
labels = c("MEX", "GTM", "SLV", "HND", "NIC", "CRI", "PAN", "COL", "ECU", "BOL", "PER", "PRY", "CHL", "URY", "BRA", "VEN", "ARG", "DOM"))
#Removemos las olas que no vamos a considerar en la muestra
lapop<-lapop[!(lapop$year<2008),]
describe(lapop$pais)
describe(lapop$year)
```
 
+ Variables de nivel individual

```{r Variables Niv 1, echo=TRUE, message=FALSE, warning=FALSE} 
#Olas: 
lapop$wave <- lapop$year
lapop$wave=rec(lapop$wave, rec=c("2008=08", "2010=10", "2012=12", "2014=14"))
describe(lapop$wave)
with(lapop, table(lapop$pais, lapop$year))

#Pais_Año:
lapop$pais_wave <- do.call(paste, c(lapop[c("pais", "wave")], sep = "_")) 

#Redistribución:
# Dummy
lapop$redistribucion_r <-as.numeric(lapop$redistribucion >= 7)
lapop$redistribucion_r <-as.factor(lapop$redistribucion_r)

# Log Natural
lapop$redistribucion_ln <- log(lapop$redistribucion)
#Tablas de resumen
table(lapop$redistribucion)
table(lapop$redistribucion_r)
table(lapop$redistribucion_ln)

#Hombre
lapop$sexo <-as.numeric(lapop$sexo <= 1)
lapop$sexo <-factor(lapop$sexo, levels = c(0,1), labels = c("Mujer", "Hombre"))
table(lapop$sexo)

#Edad
# Continua
lapop$edad[lapop$edad<=17] <- NA
# Cuadrática 
lapop$edad2 <- (lapop$edad)^2
#Tablas
describe(lapop$edad)
describe(lapop$edad2)

#Casado (o conviviente)
lapop$ecivil <-as.factor(lapop$ecivil)
lapop$ecivil_r=rec(lapop$ecivil, rec="2=1; 3=1; 7=1; 1=0; 4=0; 5=0; 6=0")
lapop$ecivil_r <-factor(lapop$ecivil_r, levels = c(0,1), labels = c("Soltero", "Casado"))
table(lapop$ecivil)
table(lapop$ecivil_r)

#Izquierda
#Continua
lapop$izquierda <- 1+10-(lapop$ideopolitica)
describe(lapop$ideopolitica)
describe(lapop$izquierda)
#Factor
lapop$ideopolitica_f=rec(lapop$izquierda, rec="1:4=1; 5:6=2; 7:10=3")
lapop$ideopolitica_f[is.na(lapop$ideopolitica_f)] = 99
lapop$ideopolitica_f <-factor(lapop$ideopolitica_f, levels = c(1,2,3, 99), labels = c("Derecha", "Centro", "Izquierda", "No declarada"))
describe(lapop$ideopolitica_f)

#Situación Laboral
lapop$sitlaboral_r=rec(lapop$sitlaboral, rec="4=1; 6=1; 3=2; 5=2; 7=2; 1:2=3")
lapop$sitlaboral_r <-factor(lapop$sitlaboral_r, levels = c(1,2,3), labels = c("No fuerza laboral", "Desempleado", "Empleado"))
describe(lapop$sitlaboral_r)

#Educación 
lapop$educacion_r=rec(lapop$educacion, rec="0:6=1; 7:12=2; 13:18=3")
lapop$educacion_r <-factor(lapop$educacion_r, levels = c(1,2,3), labels = c("Primaria", "Secundaria", "Terciaria"))
describe(lapop$educacion_r)

#Urbano
lapop$zona[lapop$zona==2] <- 0
lapop$zona <-factor(lapop$zona, levels = c(0, 1), labels = c("Rural", "Urbano"))
table(lapop$zona)

#Tamaño Ciudad
lapop$tamano <- lapop$tamanociudad
lapop$tamanociudad <- 1+5-(lapop$tamano)
lapop$tamanociudad[lapop$tamanociudad<1] <- NA
lapop$tamanociudad <-factor(lapop$tamanociudad, levels = c(1,2,3,4,5), labels = c("Área rural", "Ciudad pequeña", "Ciudad mediana", "Ciudad grande", "Capital nacional"))
describe(lapop$tamanociudad)

#Promedio confianza
lapop$confianza <- rowMeans(lapop[c("conffaa", "confpolicia", "confjudicial", "confejecutivo", "confcongreso", "confpartidos")], na.rm=TRUE)
describe(lapop$confianza)

#Personas en el hogar: se toma la cantidad de hijos en el hogar como un proxy de la variable con un ajuste de +1
lapop$nhogar <- lapop$hijos+1
describe(lapop$hijos)
describe(lapop$nhogar)
```

+ Variable ingreso

```{r Variable ingreso, echo=TRUE, message=FALSE, warning=FALSE}
#Ingreso: Se imputa el punto medio del rango para cada atributo de la respuesta, según la escala de cada país (tipo de moneda). Luego se obtiene el ingreso per cápita se transforma a logaritmo y se transforma a quintiles y deciles.

#Mexico: cod. 1
#2008
freq(to_label(lapop$ingreso[lapop$year==2008 & lapop$pais=="MEX"]))
lapop$ingreso_r[lapop$year==2008 & lapop$pais=="MEX"]<- rec(lapop$ingreso,rec="1=400;2=1201;3=2001;4=2801;5=3601;6=4701;7=6101;8=8401;9=11751;10=13500;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2008 & lapop$pais=="MEX"])
summary(lapop$ingreso_r[lapop$year==2008 & lapop$pais=="MEX"])

#2010
freq(to_label(lapop$ingreso[lapop$year==2010 & lapop$pais=="MEX"]))
lapop$ingreso_r[lapop$year==2010 & lapop$pais=="MEX"]<- rec(lapop$ingreso,rec="1=400;2=1201;3=2001;4=2801;5=3601;6=4701;7=6101;8=8401;9=11751;10=13500;
88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2010 & lapop$pais=="MEX"])
summary(lapop$ingreso_r[lapop$year==2010 & lapop$pais=="MEX"])

#2012
freq(to_label(lapop$ingreso[lapop$year==2012 & lapop$pais=="MEX"]))
lapop$ingreso_r[lapop$year==2012 & lapop$pais=="MEX"]<- rec(lapop$ingreso,rec="1=240;2=600;3=841;4=1201;5=1796;6=2511;7=3231;8=3951;9=5386;10=6821;11=7896;12=9331;13=10771;14=12206;15=13641;16=14360;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2012 & lapop$pais=="MEX"])
summary(lapop$ingreso_r[lapop$year==2012 & lapop$pais=="MEX"])

#2014
freq(to_label(lapop$ingreso[lapop$year==2014 & lapop$pais=="MEX"]))
lapop$ingreso_r[lapop$year==2014 & lapop$pais=="MEX"]<- rec(lapop$ingreso,rec="1=350;2=875;3=1276;4=1676;5=2026;6=2476;7=3001;8=3476;9=3901;10=4276;11=4926;12=5926;13=6851;14=8001;15=9951;16=11150;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2014 & lapop$pais=="MEX"])
summary(lapop$ingreso_r[lapop$year==2014 & lapop$pais=="MEX"])
#--------------------------------------------------------------------#
#Guatemala: cod. 2
#2008
freq(to_label(lapop$ingreso[lapop$year==2008 & lapop$pais=="GTM"]))
lapop$ingreso_r[lapop$year==2008 & lapop$pais=="GTM"]<- rec(lapop$ingreso,rec="1=500;2=1251;3=1751;4=2251;5=2901;6=3651;7=4501;8=5801;9=8051;10=9500;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2008 & lapop$pais=="GTM"])
summary(lapop$ingreso_r[lapop$year==2008 & lapop$pais=="GTM"])

#2010
freq(to_label(lapop$ingreso[lapop$year==2010 & lapop$pais=="GTM"]))
lapop$ingreso_r[lapop$year==2010 & lapop$pais=="GTM"]<- rec(lapop$ingreso,rec="1=500;2=1251;3=1751;4=2251;5=2901;6=3651;7=4501;8=5801;9=8051;10=9500;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2010 & lapop$pais=="GTM"])
summary(lapop$ingreso_r[lapop$year==2010 & lapop$pais=="GTM"])

#2012
freq(to_label(lapop$ingreso[lapop$year==2012 & lapop$pais=="GTM"]))
lapop$ingreso_r[lapop$year==2012 & lapop$pais=="GTM"]<- rec(lapop$ingreso,rec="1=180;2=540;3=901;4=1261;5=1621;6=1981;7=2346;8=2701;9=3056;10=3511;11=4051;12=4861;13=5941;14=7561;15=9726;16=10810;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2012 & lapop$pais=="GTM"])
summary(lapop$ingreso_r[lapop$year==2012 & lapop$pais=="GTM"])

#2014
freq(to_label(lapop$ingreso[lapop$year==2014 & lapop$pais=="GTM"]))
lapop$ingreso_r[lapop$year==2014 & lapop$pais=="GTM"]<- rec(lapop$ingreso,rec="1=180;2=480;3=721;4=961;5=1201;6=1441;7=1681;8=1921;9=2161;10=2401;11=2696;12=3056;13=3511;14=4051;15=4861;16=5400;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2014 & lapop$pais=="GTM"])
summary(lapop$ingreso_r[lapop$year==2014 & lapop$pais=="GTM"])

#--------------------------------------------------------------------#
#El salvador: cod. 3
#2008
freq(to_label(lapop$ingreso[lapop$year==2008 & lapop$pais=="SLV"]))
lapop$ingreso_r[lapop$year==2008 & lapop$pais=="SLV"]<- rec(lapop$ingreso,rec="1=23;2=68;3=118;4=217;5=361;6=505;7=649;8=865;9=1225;10=1441;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2008 & lapop$pais=="SLV"])
summary(lapop$ingreso_r[lapop$year==2008 & lapop$pais=="SLV"])

#2010
freq(to_label(lapop$ingreso[lapop$year==2010 & lapop$pais=="SLV"]))
lapop$ingreso_r[lapop$year==2010 & lapop$pais=="SLV"]<- rec(lapop$ingreso,rec="1=23;2=68;3=118;4=217;5=361;6=505;7=649;8=865;9=1225;10=1441;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2010 & lapop$pais=="SLV"])
summary(lapop$ingreso_r[lapop$year==2010 & lapop$pais=="SLV"])

#2012
freq(to_label(lapop$ingreso[lapop$year==2012 & lapop$pais=="SLV"]))
lapop$ingreso_r[lapop$year==2012 & lapop$pais=="SLV"]<- rec(lapop$ingreso,rec="1=15;2=40;3=56;4=76;5=116;6=161;7=226;8=316;9=406;10=496;11=586;12=721;13=946;14=1261;15=1621;16=1800;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2012 & lapop$pais=="SLV"])
summary(lapop$ingreso_r[lapop$year==2012 & lapop$pais=="SLV"])

#2014
freq(to_label(lapop$ingreso[lapop$year==2014 & lapop$pais=="SLV"]))
lapop$ingreso_r[lapop$year==2014 & lapop$pais=="SLV"]<- rec(lapop$ingreso,rec="1=20;2=48;3=66;4=88;5=113;6=138;7=161;8=186;9=218;10=253;11=298;12=353;13=411;14=496;15=666;16=780;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2014 & lapop$pais=="SLV"])
summary(lapop$ingreso_r[lapop$year==2014 & lapop$pais=="SLV"])

#--------------------------------------------------------------------#
#HONDURAS: cod. 4
#2008
freq(to_label(lapop$ingreso[lapop$year==2008 & lapop$pais=="HND"]))
lapop$ingreso_r[lapop$year==2008 & lapop$pais=="HND"]<- rec(lapop$ingreso,rec="1=238;2=713;3=1426;4=2376;5=3326;6=4751;7=6651;8=8551;9=11876;10=14251;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2008 & lapop$pais=="HND"])
summary(lapop$ingreso_r[lapop$year==2008 & lapop$pais=="HND"])

#2010
freq(to_label(lapop$ingreso[lapop$year==2010 & lapop$pais=="HND"]))
lapop$ingreso_r[lapop$year==2010 & lapop$pais=="HND"]<- rec(lapop$ingreso,rec="1=500;2=1751;3=3501;4=5501;5=7501;6=10501;7=13501;8=16001;9=19001;10=20501;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2010 & lapop$pais=="HND"])
summary(lapop$ingreso_r[lapop$year==2010 & lapop$pais=="HND"])

#2012
freq(to_label(lapop$ingreso[lapop$year==2012 & lapop$pais=="HND"]))
lapop$ingreso_r[lapop$year==2012 & lapop$pais=="HND"]<- rec(lapop$ingreso,rec="1=460;2=1375;3=2291;4=3211;5=4126;6=5041;7=6411;8=7786;9=8941;10=10316;11=11691;12=13756;13=16506;14=19256;15=22691;16=24750;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2012 & lapop$pais=="HND"])
summary(lapop$ingreso_r[lapop$year==2012 & lapop$pais=="HND"])

#2014
freq(to_label(lapop$ingreso[lapop$year==2014 & lapop$pais=="HND"]))
lapop$ingreso_r[lapop$year==2014 & lapop$pais=="HND"]<- rec(lapop$ingreso,rec="1=1025;2=2475;3=3176;4=3725;5=4275;6=4826;7=5376;8=6051;9=6926;10=7801;11=8701;12=9826;13=10976;14=12201;15=14676;16=16450;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2014 & lapop$pais=="HND"])
summary(lapop$ingreso_r[lapop$year==2014 & lapop$pais=="HND"])

#--------------------------------------------------------------------#
#Nicaragua: cod. 5
#2008
freq(to_label(lapop$ingreso[lapop$year==2008 & lapop$pais=="NIC"]))
lapop$ingreso_r[lapop$year==2008 & lapop$pais=="NIC"]<- rec(lapop$ingreso,rec="1=750;2=2251;3=3626;4=4876;5=7001;6=10626;7=14876;8=19126;9=23376;10=25500;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2008 & lapop$pais=="NIC"])
summary(lapop$ingreso_r[lapop$year==2008 & lapop$pais=="NIC"])

#2010
freq(to_label(lapop$ingreso[lapop$year==2010 & lapop$pais=="NIC"]))
lapop$ingreso_r[lapop$year==2010 & lapop$pais=="NIC"]<- rec(lapop$ingreso,rec="1=750;2=2251;3=3626;4=4876;5=7001;6=10626;7=14876;8=19126;9=23376;10=25500;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2010 & lapop$pais=="NIC"])
summary(lapop$ingreso_r[lapop$year==2010 & lapop$pais=="NIC"])

#2012
freq(to_label(lapop$ingreso[lapop$year==2012 & lapop$pais=="NIC"]))
lapop$ingreso_r[lapop$year==2012 & lapop$pais=="NIC"]<- rec(lapop$ingreso,rec="1=335;2=835;3=1171;4=1671;5=2336;6=2841;7=3181;8=3681;9=4511;10=5511;11=7016;12=10026;13=14036;14=18045;15=22055;16=24060;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2012 & lapop$pais=="NIC"])
summary(lapop$ingreso_r[lapop$year==2012 & lapop$pais=="NIC"])

#2014
freq(to_label(lapop$ingreso[lapop$year==2014 & lapop$pais=="NIC"]))
lapop$ingreso_r[lapop$year==2014 & lapop$pais=="NIC"]<- rec(lapop$ingreso,rec="1=550;2=1375;3=1801;4=2251;5=2776;6=3101;7=3351;8=3726;9=4201;10=4776;11=5426;12=6051;13=7026;14=8751;15=11651;16=13500;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2014 & lapop$pais=="NIC"])
summary(lapop$ingreso_r[lapop$year==2014 & lapop$pais=="NIC"])

#--------------------------------------------------------------------#
#Costa Rica: cod. 6
#2008
freq(to_label(lapop$ingreso[lapop$year==2008 & lapop$pais=="CRI"]))
lapop$ingreso_r[lapop$year==2008 & lapop$pais=="CRI"]<- rec(lapop$ingreso,rec="1=5000;2=55000;3=117500;4=155000;5=197500;6=245000;7=310000;8=400000;9=575000;10=700000;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2008 & lapop$pais=="CRI"])
summary(lapop$ingreso_r[lapop$year==2008 & lapop$pais=="CRI"])

#2010
freq(to_label(lapop$ingreso[lapop$year==2010 & lapop$pais=="CRI"]))
lapop$ingreso_r[lapop$year==2010 & lapop$pais=="CRI"]<- rec(lapop$ingreso,rec="1=53500;2=141528;3=203103;4=264869;5=335294;6=422001;7=539601;8=719638;9=1029788;10=1226501;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2010 & lapop$pais=="CRI"])
summary(lapop$ingreso_r[lapop$year==2010 & lapop$pais=="CRI"])

#2012
freq(to_label(lapop$ingreso[lapop$year==2012 & lapop$pais=="CRI"]))
lapop$ingreso_r[lapop$year==2012 & lapop$pais=="CRI"]<- rec(lapop$ingreso,rec="1=32060;2=80146;3=112201;4=160291;5=224086;6=272171;7=304871;8=352956;9=432776;10=528951;11=625126;12=721296;13=817466;14=961726;15=1154071;16=1250241;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2012 & lapop$pais=="CRI"])
summary(lapop$ingreso_r[lapop$year==2012 & lapop$pais=="CRI"])

#2014
freq(to_label(lapop$ingreso[lapop$year==2014 & lapop$pais=="CRI"]))
lapop$ingreso_r[lapop$year==2014 & lapop$pais=="CRI"]<- rec(lapop$ingreso,rec="1=44300;2=103151;3=134551;4=172976;5=209776;6=239326;7=266876;8=292626;9=318576;10=357176;11=417926;12=494551;13=581401;14=701901;15=917850;16=1059100;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2014 & lapop$pais=="CRI"])
summary(lapop$ingreso_r[lapop$year==2014 & lapop$pais=="CRI"])

#--------------------------------------------------------------------#
#Panama: cod. 7
#2008
freq(to_label(lapop$ingreso[lapop$year==2008 & lapop$pais=="PAN"]))
lapop$ingreso_r[lapop$year==2008 & lapop$pais=="PAN"]<- rec(lapop$ingreso,rec="1=50;2=150;3=300;4=500;5=700;6=900;7=1250;8=2000;9=3750;10=5000;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2008 & lapop$pais=="PAN"])
summary(lapop$ingreso_r[lapop$year==2008 & lapop$pais=="PAN"])

#2010
freq(to_label(lapop$ingreso[lapop$year==2010 & lapop$pais=="PAN"]))
lapop$ingreso_r[lapop$year==2010 & lapop$pais=="PAN"]<- rec(lapop$ingreso,rec="1=50;2=150;3=300;4=500;5=700;6=900;7=1250;8=2000;9=3750;10=5000;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2010 & lapop$pais=="PAN"])
summary(lapop$ingreso_r[lapop$year==2010 & lapop$pais=="PAN"])

#2012
freq(to_label(lapop$ingreso[lapop$year==2012 & lapop$pais=="PAN"]))
lapop$ingreso_r[lapop$year==2012 & lapop$pais=="PAN"]<- rec(lapop$ingreso,rec="1=60;2=145;3=201;4=291;5=406;6=491;7=551;8=636;9=781;10=956;11=1216;12=1736;13=2431;14=3126;15=3815;16=4160;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2012 & lapop$pais=="PAN"])
summary(lapop$ingreso_r[lapop$year==2012 & lapop$pais=="PAN"])

#2014
freq(to_label(lapop$ingreso[lapop$year==2014 & lapop$pais=="PAN"]))
lapop$ingreso_r[lapop$year==2014 & lapop$pais=="PAN"]<- rec(lapop$ingreso,rec="1=75;2=176;3=226;4=276;5=326;6=376;7=421;8=456;9=491;10=526;11=571;12=641;13=736;14=856;15=1010;16=1100;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2014 & lapop$pais=="PAN"])
summary(lapop$ingreso_r[lapop$year==2014 & lapop$pais=="PAN"])

#--------------------------------------------------------------------#
#Colombia: cod. 8
#2008
freq(to_label(lapop$ingreso[lapop$year==2008 & lapop$pais=="COL"]))
lapop$ingreso_r[lapop$year==2008 & lapop$pais=="COL"]<- rec(lapop$ingreso,rec="1=45500;2=136000;3=271000;4=541000;5=860500;6=1250001;7=1750001;8=2500001;9=3500001;10=4000001;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2008 & lapop$pais=="COL"])
summary(lapop$ingreso_r[lapop$year==2008 & lapop$pais=="COL"])

#2010
freq(to_label(lapop$ingreso[lapop$year==2010 & lapop$pais=="COL"]))
lapop$ingreso_r[lapop$year==2010 & lapop$pais=="COL"]<- rec(lapop$ingreso,rec="1=45500;2=136000;3=271000;4=541000;5=860500;6=1250001;7=1750001;8=2500001;9=3500001;10=4000001;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2010 & lapop$pais=="COL"])
summary(lapop$ingreso_r[lapop$year==2010 & lapop$pais=="COL"])

#2012
freq(to_label(lapop$ingreso[lapop$year==2012 & lapop$pais=="COL"]))
lapop$ingreso_r[lapop$year==2012 & lapop$pais=="COL"]<- rec(lapop$ingreso,rec="1=45000;2=135000;3=225000;4=315000;5=405000;6=495000;7=585000;8=670000;9=755000;10=870000;11=1020000;12=1350000;13=1850000;14=2650000;15=3750000;16=4300000;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2012 & lapop$pais=="COL"])
summary(lapop$ingreso_r[lapop$year==2012 & lapop$pais=="COL"])

#2014
freq(to_label(lapop$ingreso[lapop$year==2014 & lapop$pais=="COL"]))
lapop$ingreso_r[lapop$year==2014 & lapop$pais=="COL"]<- rec(lapop$ingreso,rec="1=80000;2=205000;3=295001;4=380001;5=450001;6=510001;7=565001;8=620001;9=685001;10=765001;11=885001;12=1030001;13=1250001;14=1650001;15=2550000;16=3200000;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2014 & lapop$pais=="COL"])
summary(lapop$ingreso_r[lapop$year==2014 & lapop$pais=="COL"])

#--------------------------------------------------------------------#
#Ecuador: cod. 9
#2008
freq(to_label(lapop$ingreso[lapop$year==2008 & lapop$pais=="ECU"]))
lapop$ingreso_r[lapop$year==2008 & lapop$pais=="ECU"]<- rec(lapop$ingreso,rec="1=30;2=81;3=151;4=251;5=401;6=626;7=876;8=1251;9=1751;10=2001;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2008 & lapop$pais=="ECU"])
summary(lapop$ingreso_r[lapop$year==2008 & lapop$pais=="ECU"])

#2010
freq(to_label(lapop$ingreso[lapop$year==2010 & lapop$pais=="ECU"]))
lapop$ingreso_r[lapop$year==2010 & lapop$pais=="ECU"]<- rec(lapop$ingreso,rec="1=30;2=81;3=151;4=251;5=401;6=626;7=876;8=1251;9=1751;10=2001;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2010 & lapop$pais=="ECU"])
summary(lapop$ingreso_r[lapop$year==2010 & lapop$pais=="ECU"])

#2012
freq(to_label(lapop$ingreso[lapop$year==2012 & lapop$pais=="ECU"]))
lapop$ingreso_r[lapop$year==2012 & lapop$pais=="ECU"]<- rec(lapop$ingreso,rec="1=20;2=65;3=111;4=156;5=201;6=241;7=286;8=331;9=376;10=431;11=496;12=661;13=926;14=1321;15=1845;16=2110;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2012 & lapop$pais=="ECU"])
summary(lapop$ingreso_r[lapop$year==2012 & lapop$pais=="GTM"])

#2014
freq(to_label(lapop$ingreso[lapop$year==2014 & lapop$pais=="ECU"]))
lapop$ingreso_r[lapop$year==2014 & lapop$pais=="ECU"]<- rec(lapop$ingreso,rec="1=65;2=155;3=201;4=241;5=273;6=298;7=331;8=363;9=388;10=431;11=496;12=596;13=726;14=926;15=1320;16=1580;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2014 & lapop$pais=="ECU"])
summary(lapop$ingreso_r[lapop$year==2014 & lapop$pais=="ECU"])

#--------------------------------------------------------------------#
#Bolivia: cod. 10
#2008
freq(to_label(lapop$ingreso[lapop$year==2008 & lapop$pais=="BOL"]))
lapop$ingreso_r[lapop$year==2008 & lapop$pais=="BOL"]<- rec(lapop$ingreso,rec="1=125;2=375;3=650;4=1001;5=1601;6=2501;7=4001;8=7500;9=15000;10=20000;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2008 & lapop$pais=="BOL"])
summary(lapop$ingreso_r[lapop$year==2008 & lapop$pais=="BOL"])

#2010
freq(to_label(lapop$ingreso[lapop$year==2010 & lapop$pais=="BOL"]))
lapop$ingreso_r[lapop$year==2010 & lapop$pais=="BOL"]<- rec(lapop$ingreso,rec="1=125;2=375;3=650;4=1001;5=1601;6=2501;7=4001;8=7500;9=15000;10=20000;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2010 & lapop$pais=="BOL"])
summary(lapop$ingreso_r[lapop$year==2010 & lapop$pais=="BOL"])

#2012
freq(to_label(lapop$ingreso[lapop$year==2012 & lapop$pais=="BOL"]))
lapop$ingreso_r[lapop$year==2012 & lapop$pais=="BOL"]<- rec(lapop$ingreso,rec="1=70;2=205;3=341;4=476;5=611;6=751;7=886;8=1016;9=1151;10=1326;11=1531;12=2041;13=2856;14=4891;15=8150;16=9780;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2012 & lapop$pais=="BOL"])
summary(lapop$ingreso_r[lapop$year==2012 & lapop$pais=="BOL"])

#2014
freq(to_label(lapop$ingreso[lapop$year==2014 & lapop$pais=="BOL"]))
lapop$ingreso_r[lapop$year==2014 & lapop$pais=="BOL"]<- rec(lapop$ingreso,rec="1=125;2=375;3=651;4=951;5=1251;6=1551;7=1851;8=2201;9=2601;10=3051;11=3651;12=4401;13=5301;14=6401;15=8500;16=10000;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2014 & lapop$pais=="BOL"])
summary(lapop$ingreso_r[lapop$year==2014 & lapop$pais=="BOL"])

#--------------------------------------------------------------------#
#Peru: cod. 11
#2008
freq(to_label(lapop$ingreso[lapop$year==2008 & lapop$pais=="PER"]))
lapop$ingreso_r[lapop$year==2008 & lapop$pais=="PER"]<- rec(lapop$ingreso,rec="1=50;2=151;3=301;4=501;5=701;6=1001;7=1401;8=1801;9=2500;10=3000;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2008 & lapop$pais=="PER"])
summary(lapop$ingreso_r[lapop$year==2008 & lapop$pais=="PER"])

#2010
freq(to_label(lapop$ingreso[lapop$year==2010 & lapop$pais=="PER"]))
lapop$ingreso_r[lapop$year==2010 & lapop$pais=="PER"]<- rec(lapop$ingreso,rec="1=50;2=151;3=301;4=501;5=701;6=1001;7=1401;8=1801;9=2500;10=3000;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2010 & lapop$pais=="PER"])
summary(lapop$ingreso_r[lapop$year==2010 & lapop$pais=="PER"])

#2012
freq(to_label(lapop$ingreso[lapop$year==2012 & lapop$pais=="PER"]))
lapop$ingreso_r[lapop$year==2012 & lapop$pais=="PER"]<- rec(lapop$ingreso,rec="1=55;2=170;3=286;4=396;5=506;6=621;7=736;8=846;9=956;10=1096;11=1266;12=1691;13=2366;14=3041;15=3715;16=4050;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2012 & lapop$pais=="PER"])
summary(lapop$ingreso_r[lapop$year==2012 & lapop$pais=="PER"])

#2014
freq(to_label(lapop$ingreso[lapop$year==2014 & lapop$pais=="PER"]))
lapop$ingreso_r[lapop$year==2014 & lapop$pais=="PER"]<- rec(lapop$ingreso,rec="1=105;2=270;3=381;4=481;5=571;6=656;7=741;8=821;9=896;10=961;11=1031;12=1141;13=1296;14=1616;15=2215;16=2580;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2014 & lapop$pais=="PER"])
summary(lapop$ingreso_r[lapop$year==2014 & lapop$pais=="PER"])

#--------------------------------------------------------------------#
#Paraguay: cod. 12
#2008
freq(to_label(lapop$ingreso[lapop$year==2008 & lapop$pais=="PRY"]))
lapop$ingreso_r[lapop$year==2008 & lapop$pais=="PRY"]<- rec(lapop$ingreso,rec="1=68500;2=206001;3=412501;4=687501;5=962501;6=1375001;7=1925001;8=2475001;9=3437501;10=4125001;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2008 & lapop$pais=="PRY"])
summary(lapop$ingreso_r[lapop$year==2008 & lapop$pais=="PRY"])

#2010
freq(to_label(lapop$ingreso[lapop$year==2010 & lapop$pais=="PRY"]))
lapop$ingreso_r[lapop$year==2010 & lapop$pais=="PRY"]<- rec(lapop$ingreso,rec="1=68500;2=206001;3=412501;4=687501;5=962501;6=1375001;7=1925001;8=2475001;9=3437501;10=4125001;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2010 & lapop$pais=="PRY"])
summary(lapop$ingreso_r[lapop$year==2010 & lapop$pais=="PRY"])

#2012
freq(to_label(lapop$ingreso[lapop$year==2012 & lapop$pais=="PRY"]))
lapop$ingreso_r[lapop$year==2012 & lapop$pais=="PRY"]<- rec(lapop$ingreso,rec="1=69095;2=207290;3=345486;4=483676;5=690966;6=967356;7=1243746;8=1520131;9=1931946;10=2346526;11=2628441;12=2902066;13=3175691;14=3731231;15=4560390;16=4974970;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2012 & lapop$pais=="PRY"])
summary(lapop$ingreso_r[lapop$year==2012 & lapop$pais=="PRY"])

#2014
freq(to_label(lapop$ingreso[lapop$year==2014 & lapop$pais=="PRY"]))
lapop$ingreso_r[lapop$year==2014 & lapop$pais=="PRY"]<- rec(lapop$ingreso,rec="1=138195;2=414580;3=690966;4=967356;5=1220711;6=1451031;7=1681356;8=1911681;9=2142001;10=2372321;11=2628441;12=2902066;13=3175691;14=3731231;15=4560390;16=4974970;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2014 & lapop$pais=="PRY"])
summary(lapop$ingreso_r[lapop$year==2014 & lapop$pais=="PRY"])

#--------------------------------------------------------------------#
#Chile: cod. 13
#2008
freq(to_label(lapop$ingreso[lapop$year==2008 & lapop$pais=="CHL"]))
lapop$ingreso_r[lapop$year==2008 & lapop$pais=="CHL"]<- rec(lapop$ingreso,rec="1=43000;2=122500;3=181500;4=241500;5=297000;6=374500;7=444000;8=492500;9=672000;10=813000;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2008 & lapop$pais=="CHL"])
summary(lapop$ingreso_r[lapop$year==2008 & lapop$pais=="CHL"])

#2010
freq(to_label(lapop$ingreso[lapop$year==2010 & lapop$pais=="CHL"]))
lapop$ingreso_r[lapop$year==2010 & lapop$pais=="CHL"]<- rec(lapop$ingreso,rec="1=43000;2=122500;3=181500;4=241500;5=297000;6=374500;7=444000;8=492500;9=672000;10=813000;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2010 & lapop$pais=="CHL"])
summary(lapop$ingreso_r[lapop$year==2010 & lapop$pais=="CHL"])

#2012
freq(to_label(lapop$ingreso[lapop$year==2012 & lapop$pais=="CHL"]))
lapop$ingreso_r[lapop$year==2012 & lapop$pais=="CHL"]<- rec(lapop$ingreso,rec="1=15165;2=45500;3=75836;4=106166;5=136501;6=166836;7=197471;8=227501;9=257531;10=295751;11=341251;12=409501;13=500501;14=637001;15=819000;16=910000;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2012 & lapop$pais=="CHL"])
summary(lapop$ingreso_r[lapop$year==2012 & lapop$pais=="CHL"])

#2014
freq(to_label(lapop$ingreso[lapop$year==2014 & lapop$pais=="CHL"]))
lapop$ingreso_r[lapop$year==2014 & lapop$pais=="CHL"]<- rec(lapop$ingreso,rec="1=61150;2=141300;3=172526;4=195276;5=218151;6=246526;7=277801;8=308676;9=344126;10=390626;11=446326;12=507876;13=591151;14=703901;15=850950;16=936000;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2014 & lapop$pais=="CHL"])
summary(lapop$ingreso_r[lapop$year==2014 & lapop$pais=="CHL"])

#--------------------------------------------------------------------#
#Uruguay: cod. 14
#2008
freq(to_label(lapop$ingreso[lapop$year==2008 & lapop$pais=="URY"]))
lapop$ingreso_r[lapop$year==2008 & lapop$pais=="URY"]<- rec(lapop$ingreso,rec="1=2250;2=5251;3=7001;4=9001;5=11001;6=13001;7=16001;8=20501;9=28001;10=33001;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2008 & lapop$pais=="URY"])
summary(lapop$ingreso_r[lapop$year==2008 & lapop$pais=="URY"])

#2010
freq(to_label(lapop$ingreso[lapop$year==2010 & lapop$pais=="URY"]))
lapop$ingreso_r[lapop$year==2010 & lapop$pais=="URY"]<- rec(lapop$ingreso,rec="1=2250;2=5251;3=7001;4=9001;5=11001;6=13001;7=16001;8=20501;9=28001;10=33001;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2010 & lapop$pais=="URY"])
summary(lapop$ingreso_r[lapop$year==2010 & lapop$pais=="URY"])

#2012
freq(to_label(lapop$ingreso[lapop$year==2012 & lapop$pais=="URY"]))
lapop$ingreso_r[lapop$year==2012 & lapop$pais=="URY"]<- rec(lapop$ingreso,rec="1=1000;2=2500;3=3501;4=5001;5=6991;6=8491;7=9511;8=11011;9=13501;10=16501;11=19501;12=22501;13=25501;14=28501;15=31500;16=33000;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2012 & lapop$pais=="URY"])
summary(lapop$ingreso_r[lapop$year==2012 & lapop$pais=="URY"])

#2014
freq(to_label(lapop$ingreso[lapop$year==2014 & lapop$pais=="URY"]))
lapop$ingreso_r[lapop$year==2014 & lapop$pais=="URY"]<- rec(lapop$ingreso,rec="1=2450;2=6025;3=8076;4=9551;5=10801;6=12351;7=14226;8=16276;9=18301;10=20726;11=23701;12=27101;13=30101;14=32351;15=34550;16=35650;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2014 & lapop$pais=="URY"])
summary(lapop$ingreso_r[lapop$year==2014 & lapop$pais=="URY"])

#--------------------------------------------------------------------#
#Brasil: cod. 15
#2008
freq(to_label(lapop$ingreso[lapop$year==2008 & lapop$pais=="BRA"]))
lapop$ingreso_r[lapop$year==2008 & lapop$pais=="BRA"]<- rec(lapop$ingreso,rec="1=19000;2=57001;3=95001;4=152001;5=228001;6=285001;7=380001;8=513001;9=665001;10=760001;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2008 & lapop$pais=="BRA"])
summary(lapop$ingreso_r[lapop$year==2008 & lapop$pais=="BRA"])

#2010
freq(to_label(lapop$ingreso[lapop$year==2010 & lapop$pais=="BRA"]))
lapop$ingreso_r[lapop$year==2010 & lapop$pais=="BRA"]<- rec(lapop$ingreso,rec="1=25500;2=76501;3=127501;4=204001;5=306001;6=382501;7=510001;8=688501;9=892501;10=1020001;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2010 & lapop$pais=="BRA"])
summary(lapop$ingreso_r[lapop$year==2010 & lapop$pais=="BRA"])

#2012
freq(to_label(lapop$ingreso[lapop$year==2012 & lapop$pais=="BRA"]))
lapop$ingreso_r[lapop$year==2012 & lapop$pais=="BRA"]<- rec(lapop$ingreso,rec="1=50;2=155;3=261;4=361;5=466;6=571;7=676;8=776;9=876;10=986;11=1086;12=1186;13=1321;14=1476;15=1705;16=1860;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2012 & lapop$pais=="BRA"])
summary(lapop$ingreso_r[lapop$year==2012 & lapop$pais=="BRA"])

#2014
freq(to_label(lapop$ingreso[lapop$year==2014 & lapop$pais=="BRA"]))
lapop$ingreso_r[lapop$year==2014 & lapop$pais=="BRA"]<- rec(lapop$ingreso,rec="1=250;2=601;3=751;4=851;5=951;6=1051;7=1151;8=1301;9=1501;10=1701;11=1901;12=2551;13=3701;14=4851;15=6001;16=6601;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2014 & lapop$pais=="BRA"])
summary(lapop$ingreso_r[lapop$year==2014 & lapop$pais=="BRA"])

#--------------------------------------------------------------------#
#Venezuela: cod. 16
#2008
freq(to_label(lapop$ingreso[lapop$year==2008 & lapop$pais=="VEN"]))
lapop$ingreso_r[lapop$year==2008 & lapop$pais=="VEN"]<- rec(lapop$ingreso,rec="1=185;2=493;3=923;4=1536;5=2146;6=2761;7=3386;8=4001;9=4601;10=4901;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2008 & lapop$pais=="VEN"])
summary(lapop$ingreso_r[lapop$year==2008 & lapop$pais=="VEN"])

#2010
freq(to_label(lapop$ingreso[lapop$year==2010 & lapop$pais=="VEN"]))
lapop$ingreso_r[lapop$year==2010 & lapop$pais=="VEN"]<- rec(lapop$ingreso,rec="1=185;2=493;3=923;4=1536;5=2146;6=2761;7=3386;8=4001;9=4601;10=4901;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2010 & lapop$pais=="VEN"])
summary(lapop$ingreso_r[lapop$year==2010 & lapop$pais=="VEN"])

#2012
freq(to_label(lapop$ingreso[lapop$year==2012 & lapop$pais=="VEN"]))
lapop$ingreso_r[lapop$year==2012 & lapop$pais=="VEN"]<- rec(lapop$ingreso,rec="1=255;2=774;3=1293;4=1741;5=2128;6=2515;7=2902;8=3289;9=3676;10=4063;11=4450;12=4899;13=5418;14=5936;15=6447;16=6702;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2012 & lapop$pais=="VEN"])
summary(lapop$ingreso_r[lapop$year==2012 & lapop$pais=="VEN"])

#2014
freq(to_label(lapop$ingreso[lapop$year==2014 & lapop$pais=="VEN"]))
lapop$ingreso_r[lapop$year==2014 & lapop$pais=="VEN"]<- rec(lapop$ingreso,rec="1=850;2=1901;3=2301;4=2626;5=2876;6=3176;7=3551;8=3951;9=4326;10=4651;11=5051;12=5651;13=6276;14=6976;15=8250;16=9100;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2014 & lapop$pais=="VEN"])
summary(lapop$ingreso_r[lapop$year==2014 & lapop$pais=="VEN"])


#--------------------------------------------------------------------#
#Argentina: cod. 17
#2008
freq(to_label(lapop$ingreso[lapop$year==2008 & lapop$pais=="ARG"]))
lapop$ingreso_r[lapop$year==2008 & lapop$pais=="ARG"]<- rec(lapop$ingreso,rec="1=250;2=751;3=1251;4=1751;5=2251;6=2751;7=3251;8=3751;9=4250;10=4500;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2008 & lapop$pais=="ARG"])
summary(lapop$ingreso_r[lapop$year==2008 & lapop$pais=="ARG"])

#2010
freq(to_label(lapop$ingreso[lapop$year==2010 & lapop$pais=="ARG"]))
lapop$ingreso_r[lapop$year==2010 & lapop$pais=="ARG"]<- rec(lapop$ingreso,rec="1=600;2=1601;3=2301;4=2951;5=3751;6=4701;7=6001;8=7851;9=10950;10=13000;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2010 & lapop$pais=="ARG"])
summary(lapop$ingreso_r[lapop$year==2010 & lapop$pais=="ARG"])

#2012
freq(to_label(lapop$ingreso[lapop$year==2012 & lapop$pais=="ARG"]))
lapop$ingreso_r[lapop$year==2012 & lapop$pais=="ARG"]<- rec(lapop$ingreso,rec="1=385;2=960;3=1341;4=1916;5=2681;6=3256;7=3646;8=4221;9=5176;10=6326;11=7476;12=8626;13=9776;14=10926;15=12650;16=13800;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2012 & lapop$pais=="ARG"])
summary(lapop$ingreso_r[lapop$year==2012 & lapop$pais=="ARG"])

#2014
freq(to_label(lapop$ingreso[lapop$year==2014 & lapop$pais=="ARG"]))
lapop$ingreso_r[lapop$year==2014 & lapop$pais=="ARG"]<- rec(lapop$ingreso,rec="1=650;2=1500;3=1851;4=2201;5=2601;6=2951;7=3301;8=3651;9=3951;10=4301;11=4801;12=5451;13=6301;14=7401;15=8950;16=9900;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2014 & lapop$pais=="ARG"])
summary(lapop$ingreso_r[lapop$year==2014 & lapop$pais=="ARG"])


#--------------------------------------------------------------------#
#Republica Dominicana: cod. 18
#2008
freq(to_label(lapop$ingreso[lapop$year==2008 & lapop$pais=="DOM"]))
lapop$ingreso_r[lapop$year==2008 & lapop$pais=="DOM"]<- rec(lapop$ingreso,rec="1=438;2=1313;3=2626;4=4376;5=6126;6=8751;7=12251;8=15751;9=21876;10=38125;11=50000;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2008 & lapop$pais=="DOM"])
summary(lapop$ingreso_r[lapop$year==2008 & lapop$pais=="DOM"])

#2010
freq(to_label(lapop$ingreso[lapop$year==2010 & lapop$pais=="DOM"]))
lapop$ingreso_r[lapop$year==2010 & lapop$pais=="DOM"]<- rec(lapop$ingreso,rec="1=1425;2=4288;3=6863;4=9151;5=11901;6=15001;7=22501;8=34501;9=50650;10=60800;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2010 & lapop$pais=="DOM"])
summary(lapop$ingreso_r[lapop$year==2010 & lapop$pais=="DOM"])

#2012
freq(to_label(lapop$ingreso[lapop$year==2012 & lapop$pais=="DOM"]))
lapop$ingreso_r[lapop$year==2012 & lapop$pais=="DOM"]<- rec(lapop$ingreso,rec="1=505;2=1510;3=2516;4=3521;5=4526;6=5536;7=7036;8=8541;9=9806;10=11316;11=15091;12=21126;13=36211;14=54316;15=66385;16=72420;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2012 & lapop$pais=="DOM"])
summary(lapop$ingreso_r[lapop$year==2012 & lapop$pais=="DOM"])

#2014
freq(to_label(lapop$ingreso[lapop$year==2014 & lapop$pais=="DOM"]))
lapop$ingreso_r[lapop$year==2014 & lapop$pais=="DOM"]<- rec(lapop$ingreso,rec="1=1400;2=3400;3=4601;4=5576;5=6451;6=7601;7=8801;8=10076;9=11251;10=12151;11=14026;12=16876;13=20201;14=25851;15=37875;16=46150;88=NA;98=NA")
table(lapop$ingreso_r[lapop$year==2014 & lapop$pais=="DOM"])
summary(lapop$ingreso_r[lapop$year==2014 & lapop$pais=="DOM"])

#Ingreso punto medio
freq(lapop$ingreso_r)

#Ingreso per cápita
lapop$ingreso_pc=lapop$ingreso_r/lapop$nhogar
lapop$ingreso_pc=log(lapop$ingreso_pc) #Logaritmo del ingreso per cápita
freq(lapop$ingreso_pc)

#Quintiles de ingreso
lapop = 
  lapop %>% 
  group_by(pais, year) %>%
  mutate(quintil=ntile(ingreso_pc,5))
freq(lapop$quintil)
#México a modo de ejemplo
freq(lapop$quintil[lapop$pais=="MEX" & lapop$year==2008])
freq(lapop$quintil[lapop$pais=="MEX" & lapop$year==2010])
freq(lapop$quintil[lapop$pais=="MEX" & lapop$year==2012])
freq(lapop$quintil[lapop$pais=="MEX" & lapop$year==2014])

#Deciles de ingreso
lapop = 
  lapop %>% 
  group_by(pais, year) %>%
  mutate(decil=ntile(ingreso_pc,10))
freq(lapop$decil)
#México a modo de ejemplo
freq(lapop$decil[lapop$pais=="MEX" & lapop$year==2008])
freq(lapop$decil[lapop$pais=="MEX" & lapop$year==2010])
freq(lapop$decil[lapop$pais=="MEX" & lapop$year==2012])
freq(lapop$decil[lapop$pais=="MEX" & lapop$year==2014])

```

+ Quintil y Decil de ingreso como variables categóricas con categoría de missing agregada 

```{r Variable ingreso categórica, echo=TRUE, message=FALSE, warning=FALSE}
lapop=as.data.frame(lapop)
lapop$quintil_f <- lapop$quintil
lapop$quintil_f [is.na(lapop$quintil_f)] <- 6
describe(lapop$quintil_f)

lapop$decil_f <- lapop$decil
lapop$decil_f [is.na(lapop$decil_f)] <- 11
describe(lapop$decil_f)
```

+ Variable de Tiempo

```{r Tiempo, echo=TRUE, message=FALSE, warning=FALSE}
#Dummy de tiempo
#2008
lapop$ano_2008 <- 0
lapop$ano_2008[lapop$year==2008] <- 1
#2008
lapop$ano_2010 <- 0
lapop$ano_2010[lapop$year==2010] <- 1
#2008
lapop$ano_2012 <- 0
lapop$ano_2012[lapop$year==2012] <- 1
#2008
lapop$ano_2014 <- 0
lapop$ano_2014[lapop$year==2014] <- 1
```

+ Variable de nivel 2

```{r Variables Niv 2, echo=TRUE, message=FALSE, warning=FALSE}
#Merge Variables de nivel país (2)
n2 <- read_dta("Bases/N2.dta")
n2=as.data.frame(n2) 
names(n2)= tolower(names(n2)) 
colnames(n2) <- c("pais", "year", "pais_nombre", "gini","pib", "gsocial", "desempleo", "informal", "bienestar", "bienestar1", "div_etnica", "div_religion", "div_lenguaje", "gini_mean", "pib_mean", "gsocial_mean", "desempleo_mean", "informal_mean", "gini_dif", "pib_dif", "gsocial_dif", "desempleo_dif", "informal_dif" )
#Países de la muestra (Etiquetas)
n2$pais <- factor(n2$pais,
levels = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18),
labels = c("MEX", "GTM", "SLV", "HND", "NIC", "CRI", "PAN", "COL", "ECU", "BOL", "PER", "PRY", "CHL", "URY", "BRA", "VEN", "ARG", "DOM"))
#Año
n2$year <- as.factor(n2$year)
#Fundir
lapop <- merge(lapop, n2, by=c("pais", "year"))
#Corregir variable de nivel 2 como factor 
as.factor(lapop$redistribucion_r)
```

+ Base de datos transitorias

```{r Save Data, echo=TRUE, message=FALSE, warning=FALSE, eval=FALSE}
#Bases de datos intermedias
save(n2, file = "n2.RData")
save(wt, file = "wt.RData") #Variable wt
save(lp081, file = "lapop08.RData")
save(lp101, file = "lapop10.RData")
save(lp121, file = "lapop12.RData")
save(lp141, file = "lapop14.RData")
save(lapop, file = "lapop.RData") #Incluye variables de nivel 1 y 2
```

+ Descriptivos de las variables de nivel 1 y nivel 2

```{r Base y descriptivos, echo=TRUE, message=FALSE, warning=FALSE}
lapop=as.data.frame(lapop) #Base en data frame 
lapop <- lapop[order(lapop$pais), ] #Ordenamos la base de datos
save(lapop, file = "lapop.RData") #Guardamos la base de datos
load("lapop.RData") #Cargamos la base
describe(lapop) #Estadísticos descriptivos de todas las variables 
```

+ Missing  

```{r Missing Data, echo=TRUE, message=FALSE, warning=FALSE}
#Listwise variables N1
lapop1 = na.omit(lapop)
lapop2 = lapop[complete.cases(lapop$redistribucion, lapop$sexo, lapop$edad, lapop$ecivil, 
                              lapop$izquierda, lapop$ideopolitica_f, lapop$sitlaboral, 
                              lapop$educacion, lapop$decil, lapop$zona,lapop$confianza),]

lapop2 = complete.cases(lapop)
lapop2=as.data.frame(lapop2)

rm(lapop)
rm(lapop2)
```

```{r Missing Data2, echo=TRUE, message=FALSE, warning=FALSE}
#Revisión de valores missing variables conflictivas
describe(lapop)

#Variable wt
lapop$wt_m <- lapop$wt
lapop$wt_m <- ifelse(is.na(lapop$wt_m), 1, 0)
lapop$wt_m <-as.factor(lapop$wt_m)
describe(lapop$wt)
describe(lapop$wt_m)
table1 <- xtabs(~wt_m+pais+wave, data=lapop)
table1

#Variable ingreso_pc
lapop$ingreso_pc_m <- lapop$ingreso_pc
lapop$ingreso_pc_m <- ifelse(is.na(lapop$ingreso_pc_m), 1, 0)
lapop$ingreso_pc_m <- as.factor(lapop$ingreso_pc_m)
describe(lapop$ingreso_pc_m)
describe(lapop$ingreso_pc_m)
table2 <- xtabs(~ingreso_pc_m+pais+wave, data=lapop)
table2

#Variable ideología política
lapop$ideopolitica_f_m <- lapop$ideopolitica_f
lapop$ideopolitica_f_m <- ifelse(is.na(lapop$ideopolitica_f_m), 1, 0)
lapop$wt_m <-as.factor(lapop$ideopolitica_f_m)
describe(lapop$ideopolitica_f)
describe(lapop$ideopolitica_f_m)
table3 <- xtabs(~lapop$ideopolitica_f_m+pais+wave, data=lapop)
table3

#Tablas con la frecuencia de los missing
ftable(table1) 
ftable(table2)
ftable(table3)
```

**No se extraen las observaciones con missing hasta tener clara la manera de proceder para las 3 varaibles en cuestión. Se procede a dejar desarrollado el código de estimación de modelos con y sin ponderadores**

+ Gráficos Descriptivos de la variable dependiente

```{r Descriptivos Redistribución, echo=TRUE, message=FALSE, warning=FALSE}
#Figura 1: Promedio de redistribución por decil general
lapop = lapop %>%  group_by(decil_f) %>% mutate(mean_redistribucion = mean(redistribucion, na.rm = TRUE))
lapop$mean_redistribucion=round(lapop$mean_redistribucion, 2)
bar_redistribucion=ggplot(lapop, aes(decil_f,mean_redistribucion))
figura1 <- bar_redistribucion + geom_bar(stat = "summary") + 
  coord_flip() +
  scale_x_continuous(breaks = unique(lapop$decil_f)) +
  scale_y_continuous(breaks = c(0:7),labels=c(0:7),limits=c(0,7)) +
  theme(axis.text.x=element_text(size=7), axis.text.y=element_text(size=7),
        axis.title=element_text(size=7,face="bold")) + 
  labs(x="Decil de ingreso", y="Redistribución") +  geom_text(aes(label = mean_redistribucion), size = 3, vjust = 0.5, hjust=-0.2) 
figura1
ggsave("Figuras/Figura1.pdf", plot=figura1)
ggsave("Figuras/Figura1.png", plot=figura1)

#Figura 2: Promedio de redistribución por decil de ingreso según país 
lapop = lapop %>%  group_by(pais, decil_f) %>% mutate(mean_redistribucionb = mean(redistribucion, na.rm = TRUE))
lapop$mean_redistribucionb=round(lapop$mean_redistribucionb, 2)
bar_redistribucionb=ggplot(lapop, aes(decil_f,mean_redistribucionb))
figura2 <- bar_redistribucionb + geom_bar(stat = "summary") + 
  facet_wrap(~lapop$pais_nombre, ncol = 3) +
  coord_flip() +
  scale_x_continuous(breaks = unique(lapop$decil_f)) +
  scale_y_continuous(breaks = c(0:7),labels=c(0:7),limits=c(0,7)) +
  theme(axis.text.x=element_text(size=20), 
        axis.text.y=element_text(size=20),
        axis.title=element_text(size=30,face="bold"),
        strip.text=element_text(size=25)) + 
  labs(x="Decil de ingreso", y="Redistribución") +  geom_text(aes(label = mean_redistribucionb), size = 10, vjust = 0.5, hjust=-0.2) 
figura2
ggsave("Figuras/Figura2.pdf", plot=figura2, height = 40, width = 40, units="in")
ggsave("Figuras/Figura2.png", plot=figura2, height = 40, width = 40, units="in")
```

+ Estadísticos Descriptivos

```{r Descriptivos, echo=TRUE, message=FALSE, warning=FALSE}
#Base auxiliar con las variables utilizadas (nivel 1 y nivel 2)
lapop=lapop %>% dplyr::select(pais, wave, pais_wave, year, id, weight1500, redistribucion, decil, quintil, edad, ideopolitica, confianza, sexo, ecivil_r, zona, sitlaboral_r, educacion_r, gini, pib, bienestar)

#Tabla 1
#Descriptivos variables de nivel 1
#Continuas (acuerdo por redistribución, decil de ingreso, edad, ideopolitica, confianza)
nivel1 = lapop %>% dplyr::select(redistribucion, decil, edad, ideopolitica, confianza)
stargazer(nivel1)
#Categóricas (sexo, estado civil, zona de residencia, situación laboral, educación)
describe(nivel1)

#Descriptivos variables de nivel 2
#Continuas (gini, pib)
nivel2 = lapop %>% dplyr::select(gini, pib)
stargazer(nivel2)
#Categóricas (regimen de bienestar)
describe(nivel2$bienestar)

#Correlaciones variables de nivel 1 y nivel 2 (variables continuas)
cor2latex(nivel1, stars=TRUE)
cor2latex(nivel2, stars=TRUE)

#Acuerdo con redistribución por países 
redistribucion <- xtabs(~pais+redistribucion, data=lapop)
redistribucion <- prop.table(redistribucion, 1)*100
redistribucion <- as.data.frame(redistribucion)
redistribucion$orden <- factor(redistribucion$pais,
levels = c("BOL","VEN","PER","GTM","HND","ECU","PAN","SLV","MEX","COL","BRA","CRI","CHL","NIC","URY","DOM","ARG","PRY"),
labels = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18))
redistribucion <- redistribucion[order(redistribucion$orden),]
rownames(redistribucion) <- 1:nrow(redistribucion)

#Figura 2: Acuerdo con redistribución por países
g1 = ggplot(data = redistribucion, aes(x=reorder(pais, orden), y = Freq, fill = redistribucion)) + 
  geom_bar(stat = "identity") + coord_flip() + 
  labs(x = "", y = "", fill="") +
  scale_fill_grey(start = .9, end = .25, name=" ") +
  scale_y_continuous(labels = function(Freq){paste0(Freq, "%") }) +
  theme(panel.background = element_rect(fill = "white"), 
        axis.text=element_text(size=10),
        strip.text=element_text(size=12))
g1


#Figura 3: Acuerdo con redistribución por país y año
g2 = ggplot(lapop, aes(x= redistribucion,  colour=year)) + 
  geom_line(aes(y = ..prop.., fill = factor(..x..)), stat="count", binwidth = 1, size = 1) +
  facet_wrap(~pais_nombre, ncol=3) +
  xlim(1, 7) +
  labs(x = "Acuerdo con Redistribución", y = "", fill="") +
  scale_color_grey(start=0.8, end=0.2, name="Año") +  
  scale_y_continuous(labels = scales::percent) +
  scale_x_continuous(breaks = c(1:7)) +
  theme(axis.text=element_text(size=15),
        strip.text=element_text(size=15),
        legend.text=element_text(size=15),
        legend.title=element_text(size=15),
        legend.key.size=unit(1,"cm"),
        legend.position = "bottom",
        panel.background = element_rect(fill = "white")) +
  theme_hc()
g2

#Tabla 2
#Acuerdo con redistribución promedio según quintil de ingreso por país
redis_ingpaisano = with(lapop2, tapply(redistribucion, list(pais, decil), mean))
stargazer(redis_ingpaisano)
```

+ Estimación Multinivel

```{r Modelos Multinivel, echo=TRUE, message=FALSE, warning=FALSE}
#Modelos sin ponderadores 
#Pais año 
modelo_0 = lmer(redistribucion ~ 1 + (1 | pais_wave) + (1 | pais), data=lapop) 
summary(modelo_0)
screenreg(modelo_0)
varcomp=as.data.frame(VarCorr(modelo_0))
varcomp
o2pais=varcomp[2,4] 
o2paisano=varcomp[1,4]
o2individuo=varcomp[3,4] 
icc_pais=o2pais/(o2pais+o2paisano+o2individuo)
icc_paisano=o2paisano/(o2pais+o2paisano+o2individuo)
icc_individuo=o2individuo/(o2pais+o2paisano+o2individuo)

icc_pais #
icc_paisano #
icc_individuo #

#1. MODELO INGRESO
## Ingreso continua
modelo_1 = lmer(redistribucion ~ 1 + decil 
                + year + (1 | pais_wave) 
                + (1 | pais), data=lapop)
screenreg(modelo_1)

#2. MODELO INDIVIDUAL (H4)
modelo_2 = lmer(redistribucion ~ 1 + decil + sexo + edad + ecivil_r 
                + izquierda + confianza + sitlaboral_r + educacion_r 
                + zona + year + (1 | pais_wave) + (1 | pais), data=lapop)
screenreg(modelo_2)

###3. MODELO GINI (H1 Y H2)
modelo_3 = lmer(redistribucion ~ 1 + decil + sexo + edad + ecivil_r 
                + izquierda + confianza + sitlaboral_r + educacion_r 
                + zona + gini_mean + gini_dif + year
                + (1 | pais_wave) + (1 | pais), data=lapop)
screenreg(modelo_3)

###4. MODELO GINI + PIB
modelo_4 = lmer(redistribucion ~ 1 + decil + sexo + edad + ecivil_r 
                + izquierda + confianza + sitlaboral_r + educacion_r 
                + zona + gini_mean + gini_dif
                + pib_mean + pib_dif + year
                + (1 | pais_wave) + (1 | pais), data=lapop)
screenreg(modelo_4)

###5. MODELO GINI + PIB + BIENESTAR (H3)
modelo_5 = lmer(redistribucion ~ 1 + decil + sexo + edad + ecivil_r 
                + izquierda + confianza + sitlaboral_r + educacion_r 
                + zona + gini_mean + gini_dif
                + pib_mean + pib_dif
                + bienestar + year
                + (1 | pais_wave) + (1 | pais), data=lapop)
screenreg(modelo_5)

###6. MODELO PAIS, PAIS_AÑO Y INDIVIDUAL (INGRESO ALEATORIO) (H4.2)
modelo_6 = lmer(redistribucion ~ 1 ++ decil + sexo + edad + ecivil_r 
                + izquierda + confianza + sitlaboral_r + educacion_r 
                + zona + gini_mean + gini_dif
                + pib_mean + pib_dif + year
                + (1 + decil| pais_wave) + (1 + decil | pais), data=lapop)
screenreg(modelo_6)

###7. MODELO PAIS, PAIS_AÑO Y INDIVIDUAL (INGRESO ALEATORIO) (INGRESO*GINI) (H5)
modelo_7 = lmer(redistribucion ~ 1 ++ decil + sexo + edad + ecivil_r 
                + izquierda + confianza + sitlaboral_r + educacion_r 
                + zona + gini_mean + gini_dif
                + pib_mean + pib_dif
                + decil*gini_mean + decil*gini_dif + year
                + (1 + decil | pais_wave) + (1 + decil | pais), data=lapop)
screenreg(modelo_7)

###8. MODELO PAIS, PAISANO Y INDIVIDUAL (INGRESO ALEATORIO) (INGRESO*PIB)

modelo_8 = lmer(redistribucion ~ 1 ++ decil + sexo + edad + ecivil_r 
                + izquierda + confianza + sitlaboral_r + educacion_r 
                + zona + gini_mean + gini_dif
                + pib_mean + pib_dif
                + decil*pib_mean + decil*pib_dif + year
                + (1 + decil | pais_wave) + (1 + decil | pais), data=lapop)
screenreg(modelo_8)

#Listar todos los modelos
texreg(list(modelo_0,modelo_1, modelo_2, modelo_3, modelo_4, 
            modelo_5, modelo_6, modelo_7, modelo_8), 
       stars = c(0.01,0.05,0.1), dcolumn = TRUE)


#Modelos Ponderados
#Pais año 
modelop_0 = lmer(redistribucion ~ 1 + (1 | pais_wave) + (1 | pais), data=lapop, weights=wt) 
summary(modelop_0)
screenreg(modelop_0)
varcomp=as.data.frame(VarCorr(modelop_0))
varcomp
o2pais=varcomp[2,4] 
o2paisano=varcomp[1,4]
o2individuo=varcomp[3,4] 
icc_pais=o2pais/(o2pais+o2paisano+o2individuo)
icc_paisano=o2paisano/(o2pais+o2paisano+o2individuo)
icc_individuo=o2individuo/(o2pais+o2paisano+o2individuo)

icc_pais #
icc_paisano #
icc_individuo #

#1. MODELO INGRESO
## Ingreso continua
modelop_1 = lmer(redistribucion ~ 1 + decil 
                + year + (1 | pais_wave) 
                + (1 | pais), data=lapop, weights=wt)
screenreg(modelop_1)

#2. MODELO INDIVIDUAL (H4)
modelop_2 = lmer(redistribucion ~ 1 + decil + sexo + edad + ecivil_r 
                + izquierda + confianza + sitlaboral_r + educacion_r 
                + zona + year + (1 | pais_wave) + (1 | pais), data=lapop, weights=wt)
screenreg(modelop_2)

###3. MODELO GINI (H1 Y H2)
modelop_3 = lmer(redistribucion ~ 1 + decil + sexo + edad + ecivil_r 
                + izquierda + confianza + sitlaboral_r + educacion_r 
                + zona + gini_mean + gini_dif + year
                + (1 | pais_wave) + (1 | pais), data=lapop, weights=wt)
screenreg(modelop_3)

###4. MODELO GINI + PIB
modelop_4 = lmer(redistribucion ~ 1 + decil + sexo + edad + ecivil_r 
                + izquierda + confianza + sitlaboral_r + educacion_r 
                + zona + gini_mean + gini_dif
                + pib_mean + pib_dif + year
                + (1 | pais_wave) + (1 | pais), data=lapop, weights=wt)
screenreg(modelop_4)

###5. MODELO GINI + PIB + BIENESTAR (H3)
modelop_5 = lmer(redistribucion ~ 1 + decil + sexo + edad + ecivil_r 
                + izquierda + confianza + sitlaboral_r + educacion_r 
                + zona + gini_mean + gini_dif
                + pib_mean + pib_dif
                + bienestar + year
                + (1 | pais_wave) + (1 | pais), data=lapop, weights=wt)
screenreg(modelop_5)

###6. MODELO PAIS, PAIS_AÑO Y INDIVIDUAL (INGRESO ALEATORIO) (H4.2)
modelop_6 = lmer(redistribucion ~ 1 ++ decil + sexo + edad + ecivil_r 
                + izquierda + confianza + sitlaboral_r + educacion_r 
                + zona + gini_mean + gini_dif
                + pib_mean + pib_dif + year
                + (1 + decil| pais_wave) + (1 + decil | pais), data=lapop, weights=wt)
screenreg(modelop_6)

###7. MODELO PAIS, PAIS_AÑO Y INDIVIDUAL (INGRESO ALEATORIO) (INGRESO*GINI) (H5)
modelop_7 = lmer(redistribucion ~ 1 ++ decil + sexo + edad + ecivil_r 
                + izquierda + confianza + sitlaboral_r + educacion_r 
                + zona + gini_mean + gini_dif
                + pib_mean + pib_dif
                + decil*gini_mean + decil*gini_dif + year
                + (1 + decil | pais_wave) + (1 + decil | pais), data=lapop, weights=wt)
screenreg(modelop_7)

###8. MODELO PAIS, PAISANO Y INDIVIDUAL (INGRESO ALEATORIO) (INGRESO*PIB)

modelop_8 = lmer(redistribucion ~ 1 ++ decil + sexo + edad + ecivil_r 
                + izquierda + confianza + sitlaboral_r + educacion_r 
                + zona + gini_mean + gini_dif
                + pib_mean + pib_dif
                + decil*pib_mean + decil*pib_dif + year
                + (1 + decil | pais_wave) + (1 + decil | pais), data=lapop, weights=wt)
screenreg(modelop_8)

#Listar todos los modelos ponderados
texreg(list(modelop_0,modelop_1, modelop_2, modelop_3, modelop_4, 
            modelop_5, modelop_6, modelop_7, modelop_8), 
       stars = c(0.01,0.05,0.1), dcolumn = TRUE)

```

+ Estimaciones Multinivel complementarias y con gráficos 

```{r Test y figuras Multinivel, echo=TRUE, message=FALSE, warning=FALSE}
#LR Test: Test Modelos Anidados (Considera modelos sin ponderadores)
lrtest (modelo_0, modelo_1)
lrtest (modelo_1, modelo_2)
lrtest (modelo_2, modelo_3)
lrtest (modelo_3, modelo_4)
lrtest (modelo_4, modelo_5)
lrtest (modelo_4, modelo_6)
lrtest (modelo_6, modelo_7)
lrtest (modelo_7, modelo_8)

#LR Test: Test Modelos Anidados (Considera modelos con ponderadores)
lrtest (modelop_0, modelop_1)
lrtest (modelop_1, modelop_2)
lrtest (modelop_2, modelop_3)
lrtest (modelop_3, modelop_4)
lrtest (modelop_4, modelop_5)
lrtest (modelop_4, modelop_6)
lrtest (modelop_6, modelop_7)
lrtest (modelop_7, modelop_8)

#Figura 4: Efecto aleatorio de Ingreso sobre Acuerdo con redistribución por país (Modelo sin ponderador): 
##Pendiente
coef_mod = as.data.frame(tidy(modelo_1, conf.int = TRUE))
coef
ggplot(coef_mod, aes(term, estimate))+
  geom_point()+
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high))+
  labs(title = "Coeficientes modelo de regresión")
cplot_modelo1 = coefplot(modelo_1)


##Intercepto
plot_model(modelo_6, 
           type = "re", 
           show.legend = TRUE,
           show.values = TRUE,
           sort.est = "decil",
           facet.grid = TRUE,
           y.offset = .4,
           value.offset = .4,
           value.size = 3.5,
           title="Efecto aleatorio de Ingreso sobre Acuerdo con Redistribución por país: intercepto y pendiente")
ranef(modelo_6)

#Figura 5: Efectos marginales:
#GINI

em_ing_ginibe1 = interplot(m = modelo_7, var1 = 'decil', var2 = 'gini_mean', ci = 0.90) + 
  xlab("Gini (Promedio)") +
  ylab("Cambio en Acuerdo con Redistribución") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  theme(axis.text=element_text(size=11),
        axis.title.y = element_text(size =12),
        axis.title.x = element_text(size = 12))
em_ing_ginibe1

em_ing_giniwe1 = interplot(m = modelo_7, var1 = 'decil', var2 = 'gini_dif', ci = 0.90) + 
  xlab("Gini (Cambio)") +
  ylab("Cambio en Acuerdo con Redistribución") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  theme(axis.text=element_text(size=11),
        axis.title.y = element_text(size =12),
        axis.title.x = element_text(size = 12))
em_ing_giniwe1


#PIB

em_ing_pibbe1 = interplot(m = modelo_8, var1 = 'decil', var2 = 'pib_mean', ci = 0.90) + 
  xlab("PIB (Promedio)") +
  ylab("Cambio en Acuerdo con Redistribución") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  theme(axis.text=element_text(size=11),
        axis.title.y = element_text(size =12),
        axis.title.x = element_text(size = 12))
em_ing_pibbe1

em_ing_pibwe1 = interplot(m = modelo_8, var1 = 'decil', var2 = 'pib_dif', ci = 0.90) + 
  xlab("PIB (Cambio)") +
  ylab("Cambio en Acuerdo con Redistribución") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  theme(axis.text=element_text(size=11),
        axis.title.y = element_text(size =12),
        axis.title.x = element_text(size = 12))
em_ing_pibwe1

```

+ Tablas y figuras anexo

```{r Anexo, echo=TRUE, message=FALSE, warning=FALSE}

```

