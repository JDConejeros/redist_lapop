---
title: 'Documento de código: Preferencias redistributivas en contextos desiguales'
author: "Gonzalo Franetovic"
date: "22/10/2018"
output:
  html_document: default
  word_document: default
---
 A continuación se presenta el documento de código de la presente investigación. Se expone paso a paso el ajuste y fundición de bases de datos, limpieza y recodificación de variables, estimación de modelo y visualizaciones gráficas. Cabe precisar que se extrajeron las bases de datos directamente desde la página web de Lapop, por lo que hay diferencias mínimas en algunas variables. 
 
+ Instalación Paquetes de trabajo

```{r echo=TRUE, message=FALSE, warning=FALSE}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(car, stargazer, haven, foreign, stargazer, xtable, psych, psy, base, magrittr, readxl, lme4, texreg, varhandle, countrycode, laeken, multilevel, ggplot2, ggthemes, extrafont, plyr, data.table, doBy, multiwayvcov, miceadds, RColorBrewer, scales, haven, margins, grDevices, interplot, lmtest, lsmeans, lattice, broom, sjPlot, lmerTest, labelled, dplyr, sjmisc, tidyverse, Hmisc)
search()


```

+ Lectura de bases de datos LAPOP 2008, 2010, 2012, 2014 y transformación a dataframe.

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE} 
#Directorio y bases de datos
lp08 <- read_dta("2008.dta")
lp10 <- read_dta("2010.dta")
lp12 <- read_dta("2012.dta")
lp14 <- read_dta("2014.dta")
#Transformación a Data Frame 
lp08=as.data.frame(lp08) 
lp10=as.data.frame(lp10)
lp12=as.data.frame(lp12)
lp14=as.data.frame(lp14)
#Nombres de las variables en minúscula
names(lp08)= tolower(names(lp08)) 
names(lp10)= tolower(names(lp10)) 
names(lp12)= tolower(names(lp12)) 
names(lp14)= tolower(names(lp14)) 
```

+ Exploración y fundición de la bases de datos 

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE} 
#Revisamos los primeros casos
head (lp08)
head (lp10)
head (lp12)
head (lp14)
#Generamos variable year para la base de 2014
lp14$year <- "2014"
label(lp14$year) <- "Año" 
#Selección de variables
#2008
lp081=lp08 %>% dplyr::select(pais, year, weight1500, ros4, q1, q2, q11, l1, ocup4a, ed, q10, ur, tamano, b12, b18, b10a, b21a, b13, b21)
colnames(lp081) <- c("pais","year","weight1500", "redistribucion", "sexo", "edad", "ecivil", "ideopolitica", "sitlaboral", "educacion", "ingreso", "zona", "tamanociudad", "conffaa", "confpolicia", "confjudicial", "confejecutivo", "confcongreso", "confpartidos")
head (lp081)
#2010
lp101=lp10 %>% dplyr::select(pais, year, weight1500, ros4, q1, q2, q11, l1, ocup4a, ed, q10, ur, tamano, b12, b18, b10a, b21a, b13, b21)
colnames(lp101) <- c("pais","year", "weight1500" , "redistribucion", "sexo", "edad", "ecivil", "ideopolitica", "sitlaboral", "educacion", "ingreso", "zona", "tamanociudad", "conffaa", "confpolicia", "confjudicial", "confejecutivo", "confcongreso", "confpartidos")
head (lp101)
#2012
lp121=lp12 %>% dplyr::select(pais, year, weight1500, ros4, q1, q2, q11, l1, ocup4a, ed, q10new, ur, tamano, b12, b18, b10a, b21a, b13, b21)
colnames(lp121) <- c("pais","year","weight1500" , "redistribucion", "sexo", "edad", "ecivil", "ideopolitica", "sitlaboral", "educacion", "ingreso", "zona", "tamanociudad", "conffaa", "confpolicia", "confjudicial", "confejecutivo", "confcongreso", "confpartidos")
head (lp121)
#2014
lp141=lp14 %>% dplyr::select(pais, year, weight1500, ros4, q1, q2, q11n, l1, ocup4a, ed, q10new, ur, tamano, b12, b18, b10a, b21a, b13, b21)
colnames(lp141) <- c("pais","year", "weight1500", "redistribucion", "sexo", "edad", "ecivil", "ideopolitica", "sitlaboral", "educacion", "ingreso", "zona", "tamanociudad", "conffaa", "confpolicia", "confjudicial", "confejecutivo", "confcongreso", "confpartidos")
head (lp141)
 #Fundir Bases de datos
lpop=rbind(lp081, lp101, lp121, lp141)
lpop <- lpop[order(lpop$pais), ]
```
 
+ Selección e identificación de los países de la muestra
 
```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE} 
#Removemos los países que no vamos a considerar en la muestra
lpop<-lpop[!(lpop$pais>21),]
lpop$pais[lpop$pais==21] <- "18"
#Países de la muestra (Etiquetas)
lpop$pais <- factor(lpop$pais,
levels = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18),
labels = c("MEX", "GTM", "SLV", "HND", "NIC", "CRI", "PAN", "COL", "ECU", "BOL", "PER", "PRY", "CHL", "URY", "BRA", "VEN", "ARG", "DOM"))
describe(lpop$pais)

```
 
+ Variables de nivel individual

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE} 
#Olas: 
lpop$wave <- lpop$year
lpop$wave=rec(lpop$wave, rec=c("2008=08", "2010=10", "2012=12", "2014=14"))
describe(lpop$wave)

#Pais_Año:
lpop$pais_wave <- do.call(paste, c(lpop[c("pais", "wave")], sep = "_")) 

#Redistribución:
# Dummy
lpop$redistribucion_r <-as.numeric(lpop$redistribucion >= 7)
as.factor(lpop$redistribucion_r)

# Log Natural
lpop$redistribucion_ln <- log(lpop$redistribucion)
#Tablas
table(lpop$redistribucion)
table(lpop$redistribucion_r)
table(lpop$redistribucion_ln)
with(lpop, table(lpop$pais, lpop$year))

#Hombre
lpop$sexo <-as.numeric(lpop$sexo <= 1)
as.factor(lpop$sexo)
table(lpop$sexo)

#Edad
# Continua
lpop$edad[lpop$edad<=17] <- NA
# Cuadrática 
lpop$edad2 <- (lpop$edad)^2
#Tablas
table(lpop$edad)
table(lpop$edad2)

#Casado (o conviviente)
lpop$ecivil_r=rec(lpop$ecivil, rec="2=1; 3=1; 7=1; 1=0; 4:6=0")
as.factor(lpop$ecivil_rec)
table(lpop$ecivil)
table(lpop$ecivil_r)

#Izquierda
#Continua
lpop$izquierda <- 1+10-(lpop$ideopolitica)
describe(lpop$ideopolitica)
describe(lpop$izquierda)
#Factor
lpop$ideopolitica_f=rec(lpop$izquierda, rec="1:4=1; 5:6=2; 7:10=3")
as.factor(lpop$ideopolitica_f)
describe(lpop$ideopolitica_f)

#Situación Laboral
lpop$sitlaboral_r=rec(lpop$sitlaboral, rec="4=1; 6=1; 3=2; 5=2; 7=2; 1:2=3")
as.factor(lpop$sitlaboral_r)
describe(lpop$sitlaboral_r)

#Educación 
lpop$educacion_r=rec(lpop$educacion, rec="0:6=1; 7:12=2; 13:18=3")
as.factor(lpop$educacion_r)
describe(lpop$educacion_r)

#Ingreso 



#Urbano
lpop$zona[lpop$zona==2] <- 0
as.factor(lpop$zona)
table(lpop$zona)

#Tamaño Ciudad
lpop$tamano <- lpop$tamanociudad
lpop$tamanociudad <- 1+5-(lpop$tamano)
lpop$tamanociudad[lpop$tamanociudad<1] <- NA
as.factor(lpop$tamanociudad)
describe(lpop$tamanociudad)

#Promedio confianza
lpop$confianza <- rowMeans(lpop[c("conffaa", "confpolicia", "confjudicial", "confejecutivo", "confcongreso", "confpartidos")], na.rm=TRUE)

#Confianza en el sistema 
#Missing=0: Inncesario realizar, con el promedio na.rm queda ok, confirmar de todos modos
#lpop$conffaa[is.na(lpop$conffaa)] <- 0 #FFAA
#lpop$confpolicia[is.na(lpop$confpolicia)] <- 0 #Policia
#lpop$confjudicial[is.na(lpop$confjudicial)] <- 0 #Judicial
#lpop$confejecutivo[is.na(lpop$confejecutivo)] <- 0 #Ejecutivo
#lpop$confcongreso[is.na(lpop$confcongreso)] <- 0 #Congreso
#lpop$confpartidos[is.na(lpop$confpartidos)] <- 0 #Partidos
```

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE} 
#Dummy de tiempo
#2008
lpop$ano_2008 <- 0
lpop$ano_2008[lpop$year==2008] <- 1
#2008
lpop$ano_2010 <- 0
lpop$ano_2010[lpop$year==2010] <- 1
#2008
lpop$ano_2012 <- 0
lpop$ano_2012[lpop$year==2012] <- 1
#2008
lpop$ano_2014 <- 0
lpop$ano_2014[lpop$year==2014] <- 1
```

```{r eval=FALSE, message=FALSE, warning=FALSE, echo=TRUE} 
#Merge Variables de nivel país (2)
n2 <- read_dta("N2.dta")
n2=as.data.frame(n2) 
names(n2)= tolower(names(n2)) 
colnames(n2) <- c("pais", "year", "pais_nombre", "gini","pib", "gsocial", "desempleo", "informal", "bienestar", "bienestar1", "div_etnica", "div_religion", "div_lenguaje", "gini_mean", "pib_mean", "gsocial_mean", "desempleo_mean", "informal_mean", "gini_dif", "pib_dif", "gsocial_dif", "desempleo_dif", "informal_dif" )
#Países de la muestra (Etiquetas)
n2$pais <- factor(n2$pais,
levels = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18),
labels = c("MEX", "GTM", "SLV", "HND", "NIC", "CRI", "PAN", "COL", "ECU", "BOL", "PER", "PRY", "CHL", "URY", "BRA", "VEN", "ARG", "DOM"))
#Año
n2$year <- as.factor(n2$year)
#Fundir
lpop <- merge(lpop, n2, by=c("pais", "year"))
```

+ Base de datos transitoria

```{r echo=TRUE, message=FALSE, warning=FALSE, eval=FALSE}
#Bases de datos intermedias
save(n2, file = "n2.RData")
save(lpop, file = "lpop.RData") #Incluye variables de nivel 1 y 2
save(lp081, file = "lpop08.RData")
save(lp101, file = "lpop10.RData")
save(lp121, file = "lpop12.RData")
save(lp141, file = "lpop14.RData")

#Bases de datos final: Omitimos missing 
save(lpop, file = "lpop.RData")
```

+ Descriptivos de las variables de nivel 1

```{r echo=TRUE, message=FALSE, warning=FALSE}
load("lpop.RData")
describe(lpop)
```

+ Modelos

```{r echo=TRUE, message=FALSE, warning=FALSE}

```



